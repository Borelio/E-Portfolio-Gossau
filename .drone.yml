kind: pipeline
type: docker
name: server

steps:
  - name: pre-build
    image: alpine
    environment:
      CONFIG:
        from_secret: config-file
    commands:
      - cd ./Server/src
      - echo $${CONFIG} > config.json
  - name: build
    image: plugins/docker
    settings:
      registry:
        from_secret: docker-registry
      username:
        from_secret: docker-username
      password:
        from_secret: docker-password
      repo:
        from_secret: docker-repo
      tags: latest
      dry_run: false
      purge: true
      context: ./Server
      dockerfile: ./Server/Dockerfile

trigger:
  event:
    - custom
    - push
    - pull_request

---
kind: pipeline
type: docker
name: after-server

steps:
  - name: deploy-to-server
    image: appleboy/drone-ssh:1.6.5-linux-amd64
    settings:
      host:
        from_secret: server-url
      username:
        from_secret: server-username
      port:
        from_secret: server-port
      key:
        from_secret: server-key
      command_timeout: 2m
      script:
        - cd /home/docker/Gossau/Server
        - docker compose pull
        - docker compose down
        - docker compose up -d

depends_on:
  - server

trigger:
  event:
    - custom
    - push
    - pull_request
